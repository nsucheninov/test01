{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string"
        },
        "omsWorkspaceRegion": {
            "type": "string"
        },
        "dashboardName": {
            "type": "string"
        },
        "emailAddress": {
            "type": "string"
        },
        "smsCountryCode": {
            "type": "string"
        },
        "smsPhoneNumber": {
            "type": "string",
            "defaultValue": ""
        },
        "voiceCountryCode": {
            "type": "string"
        },
        "voicePhoneNumber": {
            "type": "string",
            "defaultValue": ""
        },
        "dcimAccountNo": {
            "type": "string"
        },
        "dcimIBX": {
            "type": "string"
        },
        "dcimUsername": {
            "type": "securestring"
        },
        "dcimPassword": {
            "type": "securestring"
        },
        "dcimClientId": {
            "type": "securestring",
            "defaultValue": "pzP1YhV8HXrat1DiaSbGNfLvCkbWagGv"
        },
        "dcimClientSecret": {
            "type": "securestring",
            "defaultValue": "mBIkWqA3YxdT0weG"
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located including a trailing '/'"
            },
            "defaultValue": "[deployment().properties.templateLink.uri]"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
            },
            "defaultValue": ""
        }        
    },
    "variables": {
        "dcimAccountNo": "[parameters('dcimAccountNo')]",
        "dcimIBX": "[parameters('dcimIBX')]",
        "dashboardName": "[parameters('dashboardName')]",
        "secretName": {
            "omsCustomerId": "omsCustomerId",
            "omsSharedKey": "omsSharedKey",
            "dcimUserName": "dcimUserName",
            "dcimPassword": "dcimPassword",
            "dcimClientId": "dcimClientId",
            "dcimClientSecret": "dcimClientSecret",
            "authToken": "authToken",
            "refreshToken": "refreshToken"
        },
        "omsWorkspaceApi": "2017-03-15-preview",
        "omsWorkspaceName": "[concat('la-workspace-', uniqueString(subscription().subscriptionId, resourceGroup().id))]",
        "omsWorkspaceRegion": "[parameters('omsWorkspaceRegion')]",
        "omsLogType": "EqxDcimPowerType",
        "omsLogTypeCL": "[concat(variables('omsLogType'), '_CL')]",
        "omsTimeStampField": "",
        "keyVaultName": "[concat('keyVault-', uniquestring(subscription().subscriptionId, resourceGroup().id))]",
        "functionApp": {
            "name": "[concat('functionApp-', uniquestring(subscription().subscriptionId, resourceGroup().id))]",
            "apiVersion": "2016-08-01"
        },
        "nestedTemplates": {
            "omsWorkspace": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/omsWorkspace.json', parameters('_artifactsLocationSasToken')))]",
            "omsCustomViews": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/omsCustomViews.json', parameters('_artifactsLocationSasToken')))]",
            "azureFunction": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azureFunction.json', parameters('_artifactsLocationSasToken')))]",
            "omsSavedSearches": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/omsSavedSearches.json', parameters('_artifactsLocationSasToken')))]",
            "omsAlerts": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azureAlerts.json', parameters('_artifactsLocationSasToken')))]",
            "azureDashboard": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azureDashboard.json', parameters('_artifactsLocationSasToken')))]",
            "azureDashboardLite": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azureDashboardLite.json', parameters('_artifactsLocationSasToken')))]",
            "keyVault": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/keyVault.json', parameters('_artifactsLocationSasToken')))]"
        }
    },
    "resources": [
        { 
            "apiVersion": "2018-02-01",
            "name": "pid-ccddf516-4c68-51b6-bb83-dc0343c0679b",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "omsWorkspace",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').omsWorkspace]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsWorkspaceName": {
                        "value": "[variables('omsWorkspaceName')]"
                    },
                    "omsWorkspaceRegion": {
                        "value": "[variables('omsWorkspaceRegion')]"
                    },
                    "omsWorkspaceApi": {
                        "value": "[variables('omsWorkspaceApi')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "omsCustomViews",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'omsWorkspace')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').omsCustomViews]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsWorkspaceName": {
                        "value": "[variables('omsWorkspaceName')]"
                    },
                    "omsWorkspaceRegion": {
                        "value": "[variables('omsWorkspaceRegion')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "azureFunction",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'omsWorkspace')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').azureFunction]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "functionAppName": {
                        "value": "[variables('functionApp').name]"
                    },
                    "functionAppApiVersion": {
                        "value": "[variables('functionApp').apiVersion]"
                    },
                    "AZURE_KEY_VAULT_NAME": {
                        "value": "[variables('keyVaultName')]"
                    },
                    "OMS_LOG_TYPE": {
                        "value": "[variables('omsLogType')]"
                    },
                    "OMS_TIME_STAMP_FIELD": {
                        "value": "[variables('omsTimeStampField')]"
                    },
                    "OMS_CUSTOMER_ID_SECRET_NAME": {
                        "value": "[variables('secretName').omsCustomerId]"
                    },
                    "OMS_SHARED_KEY_SECRET_NAME": {
                        "value": "[variables('secretName').omsSharedKey]"
                    },
                    "DCIM_USERNAME_SECRET_NAME": {
                        "value": "[variables('secretName').dcimUserName]"
                    },
                    "DCIM_PASSWORD_SECRET_NAME": {
                        "value": "[variables('secretName').dcimPassword]"
                    },
                    "DCIM_CLIENT_ID_SECRET_NAME": {
                        "value": "[variables('secretName').dcimClientId]"
                    },
                    "DCIM_CLIENT_SECRET_SECRET_NAME": {
                        "value": "[variables('secretName').dcimClientSecret]"
                    },
                    "AUTH_TOKEN_SECRET_NAME": {
                        "value": "[variables('secretName').authToken]"
                    },
                    "REFRESH_TOKEN_SECRET_NAME": {
                        "value": "[variables('secretName').refreshToken]"
                    },
                    "DCIM_ACCOUNT_NUMBER": {
                        "value": "[parameters('dcimAccountNo')]"
                    },
                    "DCIM_IBX_NAME": {
                        "value": "[parameters('dcimIBX')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "omsSavedSearches",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'omsWorkspace')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').omsSavedSearches]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsWorkspaceName": {
                    "value": "[variables('omsWorkspaceName')]"
                    },
                    "omsLogTypeCL": {
                        "value": "[variables('omsLogTypeCL')]"
                        }
                    }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "azureAlerts",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'azureFunction')]",
                "[concat('Microsoft.Resources/deployments/', 'omsWorkspace')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').omsAlerts]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "omsWorkspaceName": {
                        "value": "[variables('omsWorkspaceName')]"
                    },
                    "functionAppName": {
                        "value": "[variables('functionApp').name]"
                    },
                    "emailAddress": {
                        "value": "[parameters('emailAddress')]"
                    },
                    "smsCountryCode": {
                        "value": "[parameters('smsCountryCode')]"
                    },
                    "smsPhoneNumber": {
                        "value": "[parameters('smsPhoneNumber')]"
                    },
                    "voiceCountryCode": {
                        "value": "[parameters('voiceCountryCode')]"
                    },
                    "voicePhoneNumber": {
                        "value": "[parameters('voicePhoneNumber')]"
                    },
                    "omsLogTypeCL": {
                        "value": "[variables('omsLogTypeCL')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "azureDashboard",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'omsWorkspace')]",
                "[concat('Microsoft.Resources/deployments/', 'azureFunction')]",
                "[concat('Microsoft.Resources/deployments/', 'omsSavedSearches')]",
                "[concat('Microsoft.Resources/deployments/', 'omsCustomViews')]",
                "[concat('Microsoft.Resources/deployments/', 'azureAlerts')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').azureDashboard]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsWorkspaceName": {
                        "value": "[variables('omsWorkspaceName')]"
                    },
                    "dashboardName": {
                        "value": "[variables('dashboardName')]"
                    },
                    "dcimAccountNo": {
                        "value": "[variables('dcimAccountNo')]"
                    },
                    "dcimIBX": {
                        "value": "[variables('dcimIBX')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2016-02-01",
            "name": "keyVault",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'omsWorkspace')]",
                "[concat('Microsoft.Resources/deployments/', 'azureFunction')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('nestedTemplates').keyVault]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "keyVaultName": {
                        "value": "[variables('keyVaultName')]"
                    },
                    "functionAppName": {
                        "value": "[variables('functionApp').name]"
                    },
                    "omsWorkspaceName": {
                        "value": "[variables('omsWorkspaceName')]"
                    },
                    "omsWorkspaceApi": {
                        "value": "[variables('omsWorkspaceApi')]"
                    },
                    "omsCustomerIdSecretName": {
                        "value": "[variables('secretName').omsCustomerId]"
                    },
                    "omsSharedKeySecretName": {
                        "value": "[variables('secretName').omsSharedKey]"
                    },
                    "secretsObject": {
                        "value": {
                            "secrets": [
                                {
                                    "name": "[variables('secretName').dcimUserName]",
                                    "value": "[parameters('dcimUserName')]"
                                },
                                {
                                    "name": "[variables('secretName').dcimPassword]",
                                    "value": "[parameters('dcimPassword')]"
                                },
                                {
                                    "name": "[variables('secretName').dcimClientId]",
                                    "value": "[parameters('dcimClientId')]"
                                },
                                {
                                    "name": "[variables('secretName').dcimClientSecret]",
                                    "value": "[parameters('dcimClientSecret')]"
                                },
                                {
                                    "name": "[variables('secretName').authToken]",
                                    "value": ""
                                }
                            ]
                        }
                    }
                }
            }
        }
    ],
    "outputs": {
        
    }
}